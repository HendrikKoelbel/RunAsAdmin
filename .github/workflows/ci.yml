name: CI Build

on:
  push:
    branches:
      - develop
      - 'claude/**'
  pull_request:
    branches:
      - main
      - master
      - develop

jobs:
  build:
    name: Build and Test
    runs-on: windows-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Display Build Information
        shell: pwsh
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Build Information" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Repository: ${{ github.repository }}" -ForegroundColor Yellow
          Write-Host "Branch: ${{ github.ref_name }}" -ForegroundColor Yellow
          Write-Host "Commit: ${{ github.sha }}" -ForegroundColor Yellow
          Write-Host "Event: ${{ github.event_name }}" -ForegroundColor Yellow
          Write-Host ".NET Version: $(dotnet --version)" -ForegroundColor Yellow
          Write-Host "========================================" -ForegroundColor Cyan

      - name: Restore Dependencies
        run: dotnet restore RunAsAdmin/RunAsAdmin.csproj

      - name: Build Debug
        run: dotnet build RunAsAdmin/RunAsAdmin.csproj -c Debug --no-restore

      - name: Publish Release (Single-File)
        run: dotnet publish RunAsAdmin/RunAsAdmin.csproj -c Release -r win-x64 --self-contained false -p:PublishSingleFile=true

      - name: Verify Build Artifacts
        shell: pwsh
        run: |
          Write-Host "Checking for build artifacts..." -ForegroundColor Yellow

          $debugExe = "RunAsAdmin\bin\Debug\net8.0-windows\win-x64\RunAsAdmin.exe"
          $publishExe = "RunAsAdmin\bin\Release\net8.0-windows\win-x64\publish\RunAsAdmin.exe"

          if (Test-Path $debugExe) {
            $debugSize = (Get-Item $debugExe).Length
            $debugSizeMB = [math]::Round($debugSize / 1MB, 2)
            Write-Host "  ✓ Debug build successful: $debugExe ($debugSizeMB MB)" -ForegroundColor Green
          } else {
            Write-Host "  ✗ Debug build failed: $debugExe not found" -ForegroundColor Red
            exit 1
          }

          if (Test-Path $publishExe) {
            $releaseSize = (Get-Item $publishExe).Length
            $releaseSizeMB = [math]::Round($releaseSize / 1MB, 2)
            Write-Host "  ✓ Release single-file publish successful: $publishExe ($releaseSizeMB MB)" -ForegroundColor Green

            # Check if any DLLs were created (should not be present for single-file)
            $publishDir = "RunAsAdmin\bin\Release\net8.0-windows\win-x64\publish"
            $dllCount = (Get-ChildItem $publishDir -Filter "*.dll" -ErrorAction SilentlyContinue | Measure-Object).Count
            if ($dllCount -eq 0) {
              Write-Host "  ✓ Single-file packaging verified (no DLLs)" -ForegroundColor Green
            } else {
              Write-Host "  ⚠ Warning: Found $dllCount DLL(s) in publish directory" -ForegroundColor Yellow
            }
          } else {
            Write-Host "  ✗ Release publish failed: $publishExe not found" -ForegroundColor Red
            exit 1
          }

      - name: Upload Build Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            RunAsAdmin/bin/Release/net8.0-windows/win-x64/publish/RunAsAdmin.exe
          retention-days: 7
          if-no-files-found: warn

      - name: Build Summary
        if: always()
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Build Summary" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan

          if ($LASTEXITCODE -eq 0) {
            Write-Host "✓ CI Build completed successfully" -ForegroundColor Green
          } else {
            Write-Host "✗ CI Build failed" -ForegroundColor Red
          }

          Write-Host "========================================" -ForegroundColor Cyan
