name: Automated Release

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**.md'
      - '.github/workflows/ci.yml'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      force_release:
        description: 'Force release even if version unchanged'
        required: false
        type: boolean
        default: false
      skip_version_check:
        description: 'Skip version validation (use with caution)'
        required: false
        type: boolean
        default: false

jobs:
  check-version:
    name: Check Version
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.version_check.outputs.should_release }}
      current_version: ${{ steps.version_check.outputs.current_version }}
      latest_version: ${{ steps.version_check.outputs.latest_version }}
      release_version: ${{ steps.version_check.outputs.release_version }}
      version_changed: ${{ steps.version_check.outputs.version_changed }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.sha }}

      - name: Debug - Show Checkout Info
        shell: pwsh
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Checkout Information" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "GitHub SHA: ${{ github.sha }}" -ForegroundColor Yellow
          Write-Host "GitHub Ref: ${{ github.ref }}" -ForegroundColor Yellow
          Write-Host "GitHub Event: ${{ github.event_name }}" -ForegroundColor Yellow
          Write-Host "Working Directory: $(Get-Location)" -ForegroundColor Yellow

          if (Test-Path "RunAsAdmin/Properties/AssemblyInfo.cs") {
            Write-Host "✓ AssemblyInfo.cs exists" -ForegroundColor Green
            $content = Get-Content "RunAsAdmin/Properties/AssemblyInfo.cs" -Raw
            if ($content -match '\[assembly:\s*AssemblyVersion\s*\(\s*"([^"]+)"\s*\)\]') {
              Write-Host "  Version found: $($matches[1])" -ForegroundColor Green
            }
          } else {
            Write-Host "✗ AssemblyInfo.cs NOT FOUND" -ForegroundColor Red
          }
          Write-Host "========================================" -ForegroundColor Cyan

      - name: Run Version Check
        id: version_check
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $scriptPath = ".github/scripts/check-version.ps1"
          $assemblyInfoPath = "RunAsAdmin/Properties/AssemblyInfo.cs"
          $repo = "${{ github.repository }}"

          & $scriptPath -AssemblyInfoPath $assemblyInfoPath -GitHubRepo $repo -GitHubToken $env:GITHUB_TOKEN

      - name: Apply Manual Overrides
        if: github.event_name == 'workflow_dispatch'
        id: override_check
        shell: pwsh
        run: |
          $shouldRelease = "${{ steps.version_check.outputs.should_release }}"
          $forceRelease = "${{ github.event.inputs.force_release }}"

          if ($forceRelease -eq "true") {
            Write-Host "Force release enabled - overriding version check" -ForegroundColor Yellow
            echo "should_release=true" >> $env:GITHUB_OUTPUT
          } else {
            echo "should_release=$shouldRelease" >> $env:GITHUB_OUTPUT
          }

      - name: Version Check Summary
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Version Check Summary" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Current Version: ${{ steps.version_check.outputs.current_version }}" -ForegroundColor Yellow
          Write-Host "Latest Release:  ${{ steps.version_check.outputs.latest_version }}" -ForegroundColor Yellow
          Write-Host "Should Release:  ${{ steps.version_check.outputs.should_release }}" -ForegroundColor Yellow
          Write-Host "Release Version: ${{ steps.version_check.outputs.release_version }}" -ForegroundColor Yellow
          Write-Host "========================================" -ForegroundColor Cyan

  build-and-release:
    name: Build and Release
    needs: check-version
    if: needs.check-version.outputs.should_release == 'true' || github.event.inputs.force_release == 'true'
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.sha }}

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Display Release Information
        shell: pwsh
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Release Build Information" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Repository:      ${{ github.repository }}" -ForegroundColor Yellow
          Write-Host "Branch:          ${{ github.ref_name }}" -ForegroundColor Yellow
          Write-Host "Commit:          ${{ github.sha }}" -ForegroundColor Yellow
          Write-Host "Release Version: ${{ needs.check-version.outputs.release_version }}" -ForegroundColor Green
          Write-Host "Event Type:      ${{ github.event_name }}" -ForegroundColor Yellow
          Write-Host ".NET Version:    $(dotnet --version)" -ForegroundColor Yellow
          Write-Host "========================================" -ForegroundColor Cyan

      - name: Restore Dependencies
        run: dotnet restore RunAsAdmin/RunAsAdmin.csproj

      - name: Publish Single-File Release
        run: dotnet publish RunAsAdmin/RunAsAdmin.csproj -c Release -r win-x64 --self-contained false -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -p:DebugType=None -p:DebugSymbols=false

      - name: Create Release Package
        id: create_package
        shell: pwsh
        run: |
          Write-Host "Creating release package..." -ForegroundColor Yellow

          $publishPath = "RunAsAdmin\bin\Release\net8.0-windows\win-x64\publish"
          $releaseExe = Join-Path $publishPath "RunAsAdmin.exe"
          $releaseZip = "RunAsAdmin.zip"

          # Verify publish directory exists
          if (-not (Test-Path $publishPath)) {
            Write-Host "✗ Publish directory not found: $publishPath" -ForegroundColor Red
            exit 1
          }

          # Check for single-file EXE
          if (-not (Test-Path $releaseExe)) {
            Write-Host "✗ Single-file executable not found: $releaseExe" -ForegroundColor Red
            Write-Host "Contents of publish directory:" -ForegroundColor Yellow
            Get-ChildItem $publishPath | ForEach-Object { Write-Host "  - $($_.Name)" }
            exit 1
          }

          $exeSize = (Get-Item $releaseExe).Length
          $exeSizeMB = [math]::Round($exeSize / 1MB, 2)
          Write-Host "✓ Single-file executable found: $releaseExe ($exeSizeMB MB)" -ForegroundColor Green

          # Verify it's truly a single file (no DLLs should be present)
          $dllCount = (Get-ChildItem $publishPath -Filter "*.dll" | Measure-Object).Count
          if ($dllCount -gt 0) {
            Write-Host "⚠ Warning: Found $dllCount DLL files in publish directory" -ForegroundColor Yellow
            Write-Host "This may indicate single-file publishing did not work correctly" -ForegroundColor Yellow
          } else {
            Write-Host "✓ No DLL files found - single-file packaging successful!" -ForegroundColor Green
          }

          # Create ZIP with only the EXE
          Write-Host "Creating ZIP package..." -ForegroundColor Yellow
          Compress-Archive -Path $releaseExe -DestinationPath $releaseZip -Force

          if (-not (Test-Path $releaseZip)) {
            Write-Host "✗ Failed to create ZIP file" -ForegroundColor Red
            exit 1
          }

          $zipSize = (Get-Item $releaseZip).Length
          $zipSizeMB = [math]::Round($zipSize / 1MB, 2)
          Write-Host "✓ Release ZIP ready: $releaseZip ($zipSizeMB MB)" -ForegroundColor Green

          echo "zip_path=$releaseZip" >> $env:GITHUB_OUTPUT
          echo "zip_size=$zipSize" >> $env:GITHUB_OUTPUT
          echo "exe_size=$exeSize" >> $env:GITHUB_OUTPUT

      - name: Create Git Tag
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $version = "${{ needs.check-version.outputs.release_version }}"

          Write-Host "Creating Git tag: $version" -ForegroundColor Yellow

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if tag already exists
          $tagExists = git tag -l $version

          if ($tagExists) {
            Write-Host "⚠ Tag $version already exists - skipping tag creation" -ForegroundColor Yellow
          } else {
            git tag -a $version -m "Release $version"
            git push origin $version
            Write-Host "✓ Tag $version created and pushed" -ForegroundColor Green
          }

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.check-version.outputs.release_version }}
          name: Release ${{ needs.check-version.outputs.release_version }}
          generate_release_notes: true
          files: |
            RunAsAdmin.zip
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}
          fail_on_unmatched_files: true
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Release Summary
        if: success()
        shell: pwsh
        run: |
          $version = "${{ needs.check-version.outputs.release_version }}"
          $repo = "${{ github.repository }}"

          Write-Host ""
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Release Created Successfully!" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Version: $version" -ForegroundColor Yellow
          Write-Host "URL: https://github.com/$repo/releases/tag/$version" -ForegroundColor Yellow
          Write-Host "========================================" -ForegroundColor Cyan

      - name: Upload Build Artifacts (for debugging)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts-${{ needs.check-version.outputs.current_version }}
          path: |
            RunAsAdmin.zip
            RunAsAdmin/bin/Release/net8.0-windows/win-x64/publish/RunAsAdmin.exe
          retention-days: 30
          if-no-files-found: warn
